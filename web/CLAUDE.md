# Web Interface

React + TypeScript + Vite presentation layer. All computational logic lives in Rust/WASM — this layer only handles display and user interaction.

## File Structure

```
web/
├── index.html
├── style.css               # All styling
├── vitest.config.ts        # Vitest browser mode config (Playwright/Chromium)
├── src/
│   ├── main.tsx            # Entry point
│   ├── App.tsx             # Layout, WASM init, framework routing
│   ├── constants.ts        # TINY_EXAMPLE tableau
│   ├── utils.ts            # Shared helpers (makeOutputFilename, isAtDefaults)
│   ├── downloadContext.ts  # Injectable download function (DownloadProvider, useDownload)
│   ├── hooks/
│   │   └── useLocalStorage.ts   # Persistent settings state
│   └── components/
│       ├── FrameworkPanel.tsx   # Framework selector (Classical/MaxEnt/SOT/NHG)
│       ├── InputPanel.tsx       # File upload + example button
│       ├── TableauPanel.tsx     # Tableau table display
│       ├── RcdPanel.tsx         # Classical OT — RCD / BCD / LFCD (includes FRed Hasse diagram)
│       ├── MaxEntPanel.tsx      # Maximum Entropy
│       ├── NhgPanel.tsx         # Noisy Harmonic Grammar
│       ├── GlaPanel.tsx         # Stochastic OT / GLA
│       ├── FactorialTypologyPanel.tsx  # Factorial Typology (Classical OT)
│       └── HasseDiagram.tsx     # Hasse diagram viewer (lazy-loads @viz-js/viz, SVG + PNG export)
├── tests/
│   ├── setup.ts            # Suite-wide beforeEach (localStorage.clear)
│   ├── helpers.tsx         # Shared renderApp / loadExample / loadFile utilities
│   ├── utils.test.ts       # Pure unit tests for makeOutputFilename
│   └── flows/
│       ├── rcd.test.tsx    # Classical OT full flow + file upload
│       ├── maxent.test.tsx
│       ├── factorial-typology.test.tsx
│       ├── gla.test.tsx    # Structural assertions only (stochastic)
│       ├── nhg.test.tsx    # Structural assertions only (stochastic)
│       └── hasse.test.tsx  # Hasse diagram: SVG render + export buttons + hidden-when-disabled
└── pkg/                    # WASM output (generated by wasm-pack)
```

## Key Patterns

- WASM is initialized in `App.tsx` via dynamic import + `useEffect`
- WASM types from `pkg/ot_soft.d.ts` are used directly (fully type-safe)
- Each algorithm panel manages its own result state and is self-contained
- Algorithm params are persisted to localStorage via the `useLocalStorage` hook
- Download functions are injected via `DownloadContext` — panels call `useDownload()` instead of `downloadTextFile` directly, making downloads interceptable in tests

## Testing

Tests use **Vitest browser mode** (Playwright/Chromium provider). WASM runs in a real browser so no mocking of `fetch` or `WebAssembly` is needed.

Run with `make web-test`.

### Adding tests for a new feature

Every new algorithm panel must have a corresponding `web/tests/flows/<name>.test.tsx`. Use the existing flow tests as a template: load the example file, run the algorithm, and assert on the result.

### Snapshot strategy

- **Deterministic algorithms** (RCD, MaxEnt, FT): inline text snapshots on download content — captured on first run, compared on future runs
- **Stochastic algorithms** (GLA, NHG): structural assertions only (check headings, log-likelihood label, download filename); no content snapshots

### Download testing

`renderApp()` in `helpers.tsx` wraps `<App>` with a `<DownloadProvider>` spy. It returns a `CapturedDownload[]` array that accumulates `{ content, filename }` for every download triggered during the test.

### Updating snapshots

After an intentional formatter change, run `vitest --update-snapshots` (or `npm test -- --update-snapshots`) to regenerate inline snapshots.
